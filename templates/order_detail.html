{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-5">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/" class="text-emerald">Home</a></li>
      <li class="breadcrumb-item"><a href="/orders" class="text-emerald">My Orders</a></li>
      <li class="breadcrumb-item active">Order #{{ order.id }}</li>
    </ol>
  </nav>

  <div class="row g-4">
    <div class="col-12 col-lg-8">
      <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Order #{{ order.id }}</h4>
            <span class="badge 
              {% if order.status == 'pending' %}bg-warning
              {% elif order.status == 'confirmed' %}bg-info
              {% elif order.status == 'packed' %}bg-info
              {% elif order.status == 'on_the_way' %}bg-primary
              {% elif order.status == 'delivered' %}bg-success
              {% elif order.status == 'cancelled' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ order.status|replace('_',' ')|capitalize }}
            </span>
          </div>
          <p class="text-slate-600 text-sm mb-1"><i class="bi bi-calendar me-1"></i>Placed on {{ order.created_at.strftime('%b %d, %Y') }} at {{ order.created_at.strftime('%I:%M %p') }}</p>
          {% if order.instructions %}
          <p class="text-slate-600 text-sm"><i class="bi bi-card-text me-1"></i>Instructions: {{ order.instructions }}</p>
          {% endif %}

          <hr class="my-4">

          <h6 class="fw-bold mb-3">Items</h6>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items %}
                <tr>
                  <td>{{ it.product_name }}</td>
                  <td class="text-center">{{ it.quantity }}</td>
                  <td class="text-end">Ksh {{ '%.2f'|format(it.unit_price) }}</td>
                  <td class="text-end">Ksh {{ '%.2f'|format(it.quantity * it.unit_price) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <div style="min-width: 280px;">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-slate-600">Delivery fee</span>
                <span>Ksh {{ '%.2f'|format(order.delivery_fee or 0) }}</span>
              </div>
              {% if order.discount_amount and order.discount_amount > 0 %}
              <div class="d-flex justify-content-between mb-1">
                <span class="text-slate-600">Discount</span>
                <span class="text-success">-Ksh {{ '%.2f'|format(order.discount_amount) }}</span>
              </div>
              {% endif %}
              <div class="d-flex justify-content-between fw-bold">
                <span>Total</span>
                <span class="text-emerald">Ksh {{ '%.2f'|format(order.total_amount) }}</span>
              </div>
            </div>
          </div>

          <!-- Payment Status & Actions -->
          <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
            {% if order.payment %}
              {% if order.payment.status == 'paid' %}
                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Payment received</span>
              {% elif order.payment.status == 'failed' %}
                <span class="badge bg-danger"><i class="bi bi-exclamation-octagon me-1"></i>Payment failed</span>
              {% else %}
                <span class="badge bg-secondary">Payment pending</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary">Payment pending</span>
            {% endif %}

            {% if not order.payment or order.payment.status != 'paid' %}
            <form class="d-flex gap-2 align-items-center" action="/payments/mpesa/start/{{ order.id }}" method="get" onsubmit="this.action = this.action + (this.phone.value ? ('?phone=' + encodeURIComponent(this.phone.value)) : '');">
              <input type="tel" name="phone" class="form-control form-control-sm" style="width: 200px;" placeholder="2547XXXXXXXX" aria-label="M-Pesa Phone (optional)">
              <button class="btn btn-success btn-sm">
                <i class="bi bi-phone me-1"></i>Pay with M-Pesa
              </button>
            </form>
            {% endif %}
          </div>

          {% if can_cancel %}
          <div class="mt-3">
            <a href="/orders/{{ order.id }}/cancel" class="btn btn-outline-danger rounded-2" onclick="return confirm('Cancel this order?');">
              <i class="bi bi-x-circle"></i> Cancel Order
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-emerald-light rounded-top-3 px-4 py-3">
          <h5 class="mb-0 text-emerald"><i class="bi bi-geo-alt me-2"></i>Delivery</h5>
        </div>
        <div class="card-body p-4">
          <div class="mb-2"><span class="text-slate-600">Zone:</span> {{ order.delivery_zone.name if order.delivery_zone else 'N/A' }}</div>
          <div class="mb-2"><span class="text-slate-600">Time slot:</span> {{ order.delivery_time_slot or 'N/A' }}</div>
          {% if order.coupon_code %}
          <div class="mb-2"><span class="text-slate-600">Coupon:</span> {{ order.coupon_code }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Order Updates Timeline -->
      <div class="card border-0 shadow-sm rounded-3 mt-3">
        <div class="card-header bg-light rounded-top-3 px-4 py-3">
          <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Order Updates</h5>
        </div>
        <div class="card-body p-4">
          {% if logs and logs|length %}
          <ul class="list-unstyled mb-0">
            {% for l in logs %}
            <li class="d-flex align-items-start mb-3">
              <span class="badge rounded-circle me-3 {{ 'bg-success' if l.status in ['confirmed','delivered'] else 'bg-secondary' }}" style="width: 10px; height: 10px;">&nbsp;</span>
              <div>
                <div class="small text-muted">{{ l.created_at.strftime('%b %d, %Y %I:%M %p') if l.created_at else '' }}</div>
                <div class="fw-semibold">{{ l.status|replace('_',' ')|capitalize }}</div>
                {% if l.notes %}<div class="text-muted small">{{ l.notes }}</div>{% endif %}
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted small">No updates yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
