{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-5">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/" class="text-emerald">Home</a></li>
      <li class="breadcrumb-item active">Shopping Cart</li>
    </ol>
  </nav>

  {% if items %}
  <div class="row g-4">
    <!-- Cart Items -->
    <div class="col-12 col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4 animate-fadeInUp flex-wrap gap-2">
        <h2 class="m-0">
        <i class="bi bi-cart3 text-emerald me-2"></i>My Shopping Cart
        </h2>
        <a id="wa-cart-order" class="btn btn-outline-success fw-600" target="_blank" rel="noopener">
          <i class="bi bi-whatsapp"></i> Order on WhatsApp
        </a>
      </div>
      {% for i in items %}
      <div class="card border-0 shadow-sm hover-shadow transition-all rounded-3 mb-3 animate-fadeInUp" style="animation-delay: {{ loop.index0 * 0.05 }}s" id="cart-item-{{ i.id }}">
        <div class="card-body p-3 p-md-4">
          <div class="row align-items-center g-3">
            <div class="col-auto">
              {% if i.product.image_url %}
              <img src="{{ cl_transform(i.product.image_url, 120, 120) or i.product.image_url }}" alt="{{ i.product.name }}" class="img-fluid rounded-2" style="width:120px;height:120px;object-fit:cover;">
              {% else %}
              <div class="bg-slate-100 rounded-2 d-flex align-items-center justify-content-center" style="width:120px;height:120px;"><i class="bi bi-image text-slate-400" style="font-size:2rem;"></i></div>
              {% endif %}
            </div>
            <div class="col">
              <a href="/product/{{ i.product.slug }}" class="text-decoration-none fw-600 d-block mb-1">{{ i.product.name }}</a>
              <div class="text-muted small">Unit: Ksh {{ '%.2f'|format(i.product.price) }}</div>
            </div>
            <div class="col-auto">
              <div class="input-group input-group-sm" style="width: 140px;">
                <button class="btn btn-outline-secondary js-cart-dec" type="button" aria-label="Decrease" data-item-id="{{ i.id }}">-</button>
                <input type="number" min="1" max="99" class="form-control text-center js-cart-qty" value="{{ i.quantity }}" data-item-id="{{ i.id }}">
                <button class="btn btn-outline-secondary js-cart-inc" type="button" aria-label="Increase" data-item-id="{{ i.id }}">+</button>
              </div>
              <div class="small mt-1">Qty: <span id="qty-{{ i.id }}">{{ i.quantity }}</span></div>
            </div>
            <div class="col-auto text-end" style="width: 160px;">
              <div class="fw-600">Subtotal</div>
              <div id="subtotal-{{ i.id }}">Ksh {{ '%.2f'|format((i.quantity or 0) * (i.product.price or 0)) }}</div>
              <a href="/cart/remove/{{ i.id }}" class="btn btn-link p-0 text-danger small">Remove</a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
  <!-- Empty Cart State -->
  <div class="row justify-content-center py-5">
    <div class="col-12 col-md-6 text-center animate-fadeInUp">
      <div class="mb-4">
        <div class="empty-state-large mb-3">
          <i class="bi bi-bag-x" style="font-size: 6rem; color: #d1d5db;"></i>
        </div>
        <h3 class="fw-bold mb-2">Your Cart is Empty</h3>
        <p class="text-slate-600 mb-4">
          Looks like you haven't added anything to your cart yet. Start shopping now!
        </p>
      </div>

      <!-- Trust Badges -->
      <div class="row g-3 mb-4">
        <div class="col-6 col-sm-4">
          <div class="text-center">
            <i class="bi bi-truck text-emerald" style="font-size: 2rem;"></i>
            <p class="text-sm text-slate-600 mt-2">Fast Delivery</p>
          </div>
        </div>
        <div class="col-6 col-sm-4">
          <div class="text-center">
            <i class="bi bi-award text-amber" style="font-size: 2rem;"></i>
            <p class="text-sm text-slate-600 mt-2">Premium Quality</p>
          </div>
        </div>
        <div class="col-6 col-sm-4">
          <div class="text-center">
            <i class="bi bi-percent text-emerald" style="font-size: 2rem;"></i>
            <p class="text-sm text-slate-600 mt-2">Best Prices</p>
          </div>
        </div>
      </div>

      <!-- CTA Button -->
      <a href="/shop" class="btn btn-emerald rounded-2 px-5 py-3 fw-semibold">
        <i class="bi bi-shop"></i> Start Shopping
      </a>
    </div>
  </div>
  {% endif %}
  </div>

<script>
function getCsrfToken() {
  const m = document.querySelector('meta[name="csrf-token"]');
  return m ? m.getAttribute('content') : '';
}

async function updateQty(itemId, newQty) {
  if (newQty < 1) {
    if (confirm('Remove this item from cart?')) {
      window.location.href = `/cart/remove/${itemId}`;
    }
    return;
  }
  try {
    const res = await fetch('/cart/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({ item_id: itemId, quantity: newQty })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      window.SHOW_TOAST && window.SHOW_TOAST(data.message || 'Could not update quantity', 'warning');
      return;
    }
    const qtyEl = document.getElementById(`qty-${itemId}`);
    if (qtyEl) qtyEl.textContent = data.quantity;
    const subEl = document.getElementById(`subtotal-${itemId}`);
    if (subEl) subEl.textContent = `Ksh ${(data.item_subtotal || 0).toFixed(2)}`;
    document.getElementById('subtotal-display').textContent = `Ksh ${(data.cart_subtotal || 0).toFixed(2)}`;
    document.getElementById('total-display').textContent = `Ksh ${(data.cart_subtotal || 0).toFixed(2)}`;
    if (data.removed) {
      const card = document.getElementById(`cart-item-${itemId}`);
      if (card) card.remove();
      const hasItems = document.querySelector('[id^="qty-"]');
      if (!hasItems) {
        window.location.reload();
      }
    }
    window.SHOW_TOAST && window.SHOW_TOAST('Quantity updated', 'info');
  } catch (e) {
    window.SHOW_TOAST && window.SHOW_TOAST('Network error updating quantity', 'warning');
  }
}

async function applyPromo() {
  const code = document.getElementById('promo-input').value.trim();
  if (!code) {
    showFeedback('Please enter a promo code', 'warning');
    return;
  }
  const currentSubtotalText = document.getElementById('subtotal-display').textContent.replace('Ksh', '').trim() || '0';
  const subtotal = parseFloat(currentSubtotalText) || 0;
  try {
    const res = await fetch('/orders/apply-coupon', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({ code, subtotal })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      showFeedback(data.message || 'Promo not valid', 'warning');
      document.getElementById('discount-row').style.display = 'none';
      document.getElementById('total-display').textContent = `Ksh ${subtotal.toFixed(2)}`;
      return;
    }
    const discount = parseFloat(data.discount || 0);
    document.getElementById('discount-display').textContent = `-Ksh ${discount.toFixed(2)}`;
    document.getElementById('discount-row').style.display = 'flex';
    const newTotal = Math.max(0, subtotal - discount);
    document.getElementById('total-display').textContent = `Ksh ${newTotal.toFixed(2)}`;
    showFeedback('Promo code applied successfully!', 'success');
  } catch (e) {
    showFeedback('Network error applying promo', 'warning');
  }
}

function showFeedback(msg, type) {
  const el = document.getElementById('promo-feedback');
  el.className = `text-${type === 'success' ? 'success' : 'warning'}`;
  el.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
}

async function saveForLater(itemId) {
  try {
    const res = await fetch('/cart/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({ item_id: itemId })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      window.SHOW_TOAST && window.SHOW_TOAST(data.message || 'Could not save item', 'warning');
      return;
    }
    const card = document.getElementById(`cart-item-${itemId}`);
    if (card) card.remove();
    if (data.cart_subtotal !== undefined) {
      document.getElementById('subtotal-display').textContent = `Ksh ${Number(data.cart_subtotal).toFixed(2)}`;
      document.getElementById('total-display').textContent = `Ksh ${Number(data.cart_subtotal).toFixed(2)}`;
    }
    window.SHOW_TOAST && window.SHOW_TOAST('Saved for later', 'info');
    const hasItems = document.querySelector('[id^="qty-"]');
    if (!hasItems) {
      window.location.reload();
    }
  } catch (e) {
    window.SHOW_TOAST && window.SHOW_TOAST('Network error saving item', 'warning');
  }
}

// Simple skeleton effect on first load
document.addEventListener('DOMContentLoaded', () => {
  const cartItems = document.querySelectorAll('.card');
  cartItems.forEach(card => {
    card.classList.add('skeleton-loading');
    setTimeout(() => card.classList.remove('skeleton-loading'), 400 + Math.random() * 400);
  });
  // Quantity controls
  document.body.addEventListener('click', (e)=>{
    const dec = e.target.closest('.js-cart-dec');
    const inc = e.target.closest('.js-cart-inc');
    if (!dec && !inc) return;
    const id = parseInt((dec||inc).getAttribute('data-item-id'));
    const input = document.querySelector(`.js-cart-qty[data-item-id="${id}"]`);
    let qty = parseInt(input && input.value || '1');
    if (dec) qty = Math.max(1, qty - 1);
    if (inc) qty = Math.min(99, qty + 1);
    if (input) input.value = String(qty);
    updateQty(id, qty);
  });
  document.body.addEventListener('change', (e)=>{
    const inp = e.target.closest('.js-cart-qty');
    if (!inp) return;
    const id = parseInt(inp.getAttribute('data-item-id'));
    let qty = parseInt(inp.value || '1');
    qty = Math.max(1, Math.min(99, isNaN(qty) ? 1 : qty));
    inp.value = String(qty);
    updateQty(id, qty);
  });
  // Build WhatsApp cart deeplink (prefilled with items and subtotal)
  try{
    var waBtn = document.getElementById('wa-cart-order');
    if (waBtn){
      var site = {{ (site_name or 'ScholaGro')|tojson }};
      var waNum = {{ (config.get('WHATSAPP_NUMBER') or '')|tojson }};
      waNum = (waNum || '').replace(/\D/g,'');
      if (waNum && waNum.charAt(0) === '0' && waNum.length >= 9) waNum = '254' + waNum.slice(1);
      if (waNum && /^7\d{8}$/.test(waNum)) waNum = '254' + waNum;
      var lines = [site + ' Order Request'];
      var items = document.querySelectorAll('[id^="cart-item-"]');
      items.forEach(function(card){
        try{
          var nameEl = card.querySelector('a[href^="/product/"]');
          var name = nameEl ? (nameEl.textContent||'').trim() : 'Item';
          var url = nameEl ? (nameEl.getAttribute('href')||'') : '';
          var qtyEl = card.querySelector('[id^="qty-"]');
          var qty = qtyEl ? (qtyEl.textContent||'1').trim() : '1';
          var imgEl = card.querySelector('img');
          var img = imgEl ? (imgEl.getAttribute('src')||'') : '';
          var priceEl = card.querySelector('.text-muted');
          var price = '';
          if (priceEl){ var t = (priceEl.textContent||'').replace(/[^0-9.]/g,''); if (t) price = t; }
          lines.push('- ' + name + ' x' + qty + (price?(' â€” Ksh ' + price):''));
          if (img) lines.push(img);
          if (url){
            var full = url[0] === '/' ? (window.location.origin + url) : url;
            lines.push(full);
          }
        }catch(_){}
      });
      // Subtotal line
      var totalEl = document.getElementById('total-display');
      var subText = totalEl && totalEl.textContent ? totalEl.textContent : '';
      if (!subText){
        var sum = 0;
        var subs = document.querySelectorAll('[id^="subtotal-"]');
        subs.forEach(function(el){
          var t = (el.textContent||'').replace('Ksh','').trim();
          var v = parseFloat(t)||0; sum += v;
        });
        subText = 'Ksh ' + sum.toFixed(2);
      }
      lines.push('Subtotal: ' + subText.replace(/\s+/g,' ').trim());
      var msg = encodeURIComponent(lines.join('\n'));
      waBtn.href = waNum ? ('https://wa.me/' + waNum + '?text=' + msg) : ('https://wa.me/?text=' + msg);
    }
  }catch(e){}
});
</script>
{% endblock %}

