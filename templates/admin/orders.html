{% extends 'admin/base.html' %}
{% block breadcrumbs %}
  <nav class="px-4 pb-3 text-sm text-slate-500 dark:text-slate-400" aria-label="breadcrumb">
    <ol class="breadcrumb m-0">
      <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
      <li class="breadcrumb-item active" aria-current="page">Orders</li>
    </ol>
  </nav>
{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-3">
  <h3 class="text-xl font-semibold">Manage Orders</h3>
  <form method="get" class="flex items-center gap-2">
    <input class="rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-sm" name="q" value="{{ q or '' }}" placeholder="Search id/email/status">
    <button class="inline-flex items-center px-3 py-1 rounded-md border border-slate-300 dark:border-slate-700">Search</button>
  </form>
  </div>
<div class="text-sm text-slate-500 mb-2">Total: {{ total }} â€¢ Page {{ page }} of {{ (total // per_page) + (1 if total % per_page else 0) }}</div>
<div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 overflow-x-auto">
  <table class="min-w-full text-sm" data-search="orders">
    <thead class="text-left text-slate-500">
      <tr>
        <th class="py-2 px-3">ID</th>
        <th class="py-2 px-3">User</th>
        <th class="py-2 px-3">Status</th>
        <th class="py-2 px-3">Total</th>
        <th class="py-2 px-3">Created</th>
        <th class="py-2 px-3">Action</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
      {% for o in orders %}
      <tr>
        <td class="py-2 px-3">#{{o.id}}</td>
        <td class="py-2 px-3">{{o.user.email if o.user else ''}}</td>
        <td class="py-2 px-3">
          {% set s = o.status %}
          {% if s in ['paid','delivered','confirmed'] %}
            <span class="badge-pill pill-success">{{ s }}</span>
          {% elif s in ['pending','packed','on_the_way'] %}
            <span class="badge-pill pill-warning">{{ s }}</span>
          {% else %}
            <span class="badge-pill pill-danger">{{ s }}</span>
          {% endif %}
        </td>
        <td class="py-2 px-3">Ksh {{o.total_amount}}</td>
        <td class="py-2 px-3">{{o.created_at}}</td>
        <td class="py-2 px-3">
          <form method="post" action="/admin/orders/{{o.id}}/status" class="flex items-center gap-2 js-confirm" data-confirm="Update this order status?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <select name="status" class="rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1">
              {% set statuses = ['pending','packed','on_the_way','delivered','confirmed','cancelled'] %}
              {% for s in statuses %}
                <option value="{{s}}" {% if s==o.status %}selected{% endif %}>{{s.replace('_',' ').title()}}</option>
              {% endfor %}
            </select>
            <button class="inline-flex items-center px-3 py-1 rounded-md bg-brand text-white hover:bg-emerald-600">Update</button>
          </form>
          {% if riders %}
          <form method="post" action="/admin/orders/{{o.id}}/assign" class="flex items-center gap-2 mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <select name="rider_id" class="rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1">
              <option value="">Assign Rider</option>
              {% for r in riders %}
              <option value="{{ r.id }}" {% if o.rider and o.rider.id == r.id %}selected{% endif %}>{{ r.name }} ({{ r.phone }})</option>
              {% endfor %}
            </select>
            <button class="inline-flex items-center px-3 py-1 rounded-md border border-slate-300 dark:border-slate-700">Assign</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<nav class="mt-3">
  {% set pages = (total // per_page) + (1 if total % per_page else 0) %}
  <ul class="pagination pagination-sm">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}"><a class="page-link" href="?page={{ page-1 }}&per_page={{ per_page }}&q={{ q|urlencode }}">Prev</a></li>
    <li class="page-item disabled"><span class="page-link">{{ page }}/{{ pages }}</span></li>
    <li class="page-item {% if page >= pages %}disabled{% endif %}"><a class="page-link" href="?page={{ page+1 }}&per_page={{ per_page }}&q={{ q|urlencode }}">Next</a></li>
  </ul>
  </nav>
{% endblock %}
