{% extends 'base.html' %}
{% block title %}{{ product.name }} • {{ site_name }}{% endblock %}
{% block meta %}
  <meta name="description" content="Buy {{ product.name }} at {{ site_name }}. Fresh delivery.">
  <meta property="og:title" content="{{ product.name }} — {{ site_name }}">
  <meta property="og:description" content="Shop fresh groceries with fast delivery.">
  <meta property="og:type" content="product">
  {% if product.image_url %}
  <meta property="og:image" content="{{ cl_transform(product.image_url, 1200, 630) }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  {% else %}
  <meta property="og:image" content="https://placehold.co/1200x630">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  {% endif %}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ product.name }} — {{ site_name }}">
  <meta name="twitter:description" content="Buy {{ product.name }} at {{ site_name }}.">
  {% if product.image_url %}
  <meta name="twitter:image" content="{{ cl_transform(product.image_url, 1200, 630) }}">
  {% else %}
  <meta name="twitter:image" content="https://placehold.co/1200x630">
  {% endif %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": {{ product.name|tojson }},
    "image": [{{ (product.image_url and cl_transform(product.image_url, 1200, 800) or 'https://placehold.co/1200x800')|tojson }}],
    "description": {{ (product.description or '')|tojson }},
    "sku": {{ (product.id|string)|tojson }},
    "offers": {
      "@type": "Offer",
      "priceCurrency": "KES",
      "price": {{ (product.price|string)|tojson }},
      "availability": {{ ('https://schema.org/InStock' if (product.stock is none or product.stock|int > 0) else 'https://schema.org/OutOfStock')|tojson }},
      "url": {{ ('/product/' ~ product.slug)|tojson }}
    }{% if avg_rating %},
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": {{ (avg_rating|string)|tojson }},
      "reviewCount": {{ (reviews|length|string)|tojson }}
    }
    {% endif %}
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {"@type": "ListItem", "position": 1, "name": "Home", "item": {{ url_for('shop.home', _external=True)|tojson }}},
      {% if product.category %}
      {"@type": "ListItem", "position": 2, "name": {{ product.category.name|tojson }}, "item": {{ url_for('shop.category', slug=product.category.slug, _external=True)|tojson }}},
      {% endif %}
      {"@type": "ListItem", "position": 3, "name": {{ product.name|tojson }}, "item": {{ url_for('shop.product', slug=product.slug, _external=True)|tojson }}}
    ]
  }
  </script>
{% endblock %}
{% block content %}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4 animate-slideInUp">
  <ol class="breadcrumb bg-light p-3 rounded">
    <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
    <li class="breadcrumb-item"><a href="/shop" class="text-decoration-none">Shop</a></li>
    {% if product.category %}
    <li class="breadcrumb-item"><a href="/shop?category={{product.category.id}}" class="text-decoration-none">{{ product.category.name }}</a></li>
    {% endif %}
    <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
  </ol>
</nav>

<div class="row g-5 align-items-start mb-5 animate-fadeInUp">
  <div class="col-md-6">
    <!-- Product Image with Premium styling -->
    <div class="ratio ratio-4x3 bg-light rounded-3 overflow-hidden shadow-lg hover-lift mb-3">
      <img class="w-100 h-100 object-fit-cover" src="{{ cl_transform(product.image_url, 800, 600) or 'https://placehold.co/800x600' }}" alt="{{product.name}}" loading="lazy">
    </div>

    <!-- Product Badges on image -->
    <div class="mt-2 d-flex gap-2 flex-wrap">
      {% if is_deal %}
      <span class="badge bg-danger text-white"><i class="bi bi-lightning-fill me-1"></i>Deal</span>
      {% endif %}
      {% if is_new %}
      <span class="badge bg-success text-white"><i class="bi bi-star-fill me-1"></i>New</span>
      {% endif %}
    </div>

    <!-- Trust badges -->
    <div class="row g-2 text-center small">
      <div class="col-6">
        <div class="bg-light rounded p-2">
          <i class="bi bi-shield-check text-success fs-5"></i>
          <div class="fw-600 text-muted">Quality Assured</div>
        </div>
      </div>
      <div class="col-6">
        <div class="bg-light rounded p-2">
          <i class="bi bi-truck text-success fs-5"></i>
          <div class="fw-600 text-muted">Fast Delivery</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <!-- Product Info -->
    <div class="mb-4">
      {% if product.category %}
      <a href="/shop?category={{product.category.id}}" class="badge bg-light text-success text-decoration-none mb-2">{{ product.category.name }}</a>
      {% endif %}
      
      <h1 class="fw-bold mb-3 heading-accent">{{product.name}}</h1>
      
      <!-- Ratings -->
      {% if avg_rating %}
      <div class="mb-3 d-flex align-items-center gap-2">
        <div class="text-warning" style="font-size: 1.3rem;">
          {% for i in range(int(avg_rating)) %}⭐{% endfor %}
          {% if avg_rating % 1 != 0 %}✨{% endif %}
        </div>
        <span class="text-muted"><strong>{{ avg_rating }}/5</strong> ({{reviews|length}} reviews)</span>
      </div>
      {% endif %}
      
      <!-- Price Section -->
      <div class="mb-4 p-3 bg-light rounded-2">
        <div class="d-flex align-items-center gap-3">
          <div>
            <div class="text-muted small">Price</div>
            <span class="text-success fs-2 fw-bold">Ksh {{product.price}}</span>
            {% if product.old_price %}
            <div class="text-muted small">
              <small class="text-decoration-line-through">Ksh {{product.old_price}}</small>
              <span class="ms-2 badge bg-danger">Save {{ ((product.old_price - product.price) / product.old_price * 100)|int }}%</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Stock Status -->
      <div class="mb-4">
        {% if product.stock is not none and product.stock|int <= 0 %}
          <div class="alert alert-warning mb-3" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>Currently out of stock. <a href="#" class="alert-link">Notify me when available</a>
          </div>
        {% else %}
          <div class="alert alert-success mb-3" role="alert">
            <i class="bi bi-check-circle me-2"></i><strong>In Stock</strong> - Order now for same-day delivery
          </div>
        {% endif %}
      </div>

      <!-- Description -->
      <div class="mb-4">
        <h5 class="fw-bold mb-2">About This Product</h5>
        <p class="text-muted lh-lg">{{product.description or 'Premium quality fresh produce, hand-selected for your satisfaction.'}}</p>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2 mb-4 flex-wrap">
        {% if current_user.is_authenticated %}
          {% if product.stock is not none and product.stock|int <= 0 %}
            <button class="btn btn-secondary btn-lg px-5" disabled>
              <i class="bi bi-bag me-2"></i>Out of Stock
            </button>
          {% else %}
            <button class="btn btn-success btn-lg px-5 btn-add-to-cart fw-600" data-product-id="{{product.id}}">
              <i class="bi bi-bag-plus-fill me-2"></i>Add to Cart
            </button>
          {% endif %}
          <button class="btn btn-outline-danger btn-lg px-5 btn-wishlist fw-600" data-product-id="{{product.id}}">
            <i class="bi bi-heart me-2"></i>Save
          </button>
        {% else %}
          <a class="btn btn-success btn-lg px-5 fw-600" href="/auth/login">
            <i class="bi bi-box-arrow-in-right me-2"></i>Login to Buy
          </a>
        {% endif %}
      </div>

      <!-- Share Options -->
      <div class="border-top pt-3">
        <small class="text-muted d-block mb-2">Share this product:</small>
        <div class="d-flex gap-2">
          <a href="https://www.facebook.com/sharer/sharer.php?u={{request.url}}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary rounded-circle" title="Share on Facebook"><i class="bi bi-facebook"></i></a>
          <a href="https://twitter.com/intent/tweet?url={{request.url}}&text={{product.name}}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary rounded-circle" title="Share on Twitter"><i class="bi bi-twitter"></i></a>
          <a href="https://wa.me/?text={{product.name}} {{request.url}}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary rounded-circle" title="Share on WhatsApp"><i class="bi bi-whatsapp"></i></a>
          <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="navigator.clipboard.writeText(window.location.href)" title="Copy link"><i class="bi bi-link"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reviews Section -->
<hr class="my-5">
<div class="row g-4">
  <div class="col-lg-6 animate-slideInLeft">
    <h4 class="fw-bold mb-4 heading-accent"><i class="bi bi-chat-dots-fill me-2"></i>Customer Reviews</h4>
    
    {% if reviews %}
      {% for r in reviews %}
        <div class="card border-0 shadow-sm mb-3 hover-lift">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="text-warning mb-1" style="font-size: 0.9rem;">
                  {% for i in range(r.rating) %}⭐{% endfor %}{% for i in range(5 - r.rating) %}☆{% endfor %}
                </div>
                <div class="fw-600 small text-muted">{{ r.user.name or r.user.email if r.user else 'Anonymous' }}</div>
              </div>
              <small class="text-muted">{{ r.created_at.strftime('%d %b %Y') if r.created_at else 'Recently' }}</small>
            </div>
            <p class="card-text text-muted mb-0">{{ r.comment or '(No comment provided)' }}</p>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>No reviews yet. Be the first to share your experience!
      </div>
    {% endif %}
  </div>

  <div class="col-lg-6 animate-slideInRight">
    <h4 class="fw-bold mb-4 heading-accent"><i class="bi bi-pencil-square me-2"></i>Write a Review</h4>
    
    {% if current_user.is_authenticated %}
      <form method="post" action="/product/{{product.slug}}/review" data-product-id="{{ product.id }}" class="card border-0 shadow-sm p-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="mb-3">
          <label class="form-label fw-600">Your Rating</label>
          <div class="rating-input">
            {% for i in range(1, 6) %}
              <input type="radio" id="rating-{{i}}" name="rating" value="{{i}}" class="rating-radio" required style="display:none;">
              <label for="rating-{{i}}" class="rating-star me-2" style="font-size: 1.8rem; cursor: pointer;">★</label>
            {% endfor %}
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-600">Your Review (Optional)</label>
          <textarea class="form-control form-control-lg" name="comment" rows="4" placeholder="Share your thoughts about this product. What did you like? Any suggestions?" maxlength="500"></textarea>
          <small class="text-muted d-block mt-1"><span id="char-count">0</span>/500 characters</small>
        </div>
        
        <button type="submit" class="btn btn-success btn-lg w-100 fw-600">
          <i class="bi bi-send-fill me-2"></i>Submit Your Review
        </button>
      </form>

      <script>
        // Star rating interaction
        document.querySelectorAll('.rating-star').forEach(star => {
          star.addEventListener('click', function() {
            const rating = this.previousElementSibling.value;
            document.querySelectorAll('.rating-star').forEach((s, i) => {
              if (i < rating) {
                s.style.color = '#f59e0b';
              } else {
                s.style.color = '#d1d5db';
              }
            });
          });
          
          star.addEventListener('mouseenter', function() {
            const idx = Array.from(document.querySelectorAll('.rating-star')).indexOf(this);
            document.querySelectorAll('.rating-star').forEach((s, i) => {
              s.style.color = i <= idx ? '#f59e0b' : '#d1d5db';
            });
          });
        });

        document.querySelector('.rating-input').addEventListener('mouseleave', function() {
          const checked = document.querySelector('.rating-radio:checked');
          document.querySelectorAll('.rating-star').forEach((s, i) => {
            s.style.color = (checked && i < checked.value) ? '#f59e0b' : '#d1d5db';
          });
        });

        // Character counter
        document.querySelector('textarea[name="comment"]').addEventListener('input', function() {
          document.getElementById('char-count').textContent = this.value.length;
        });
      </script>
    {% else %}
      <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <a href="/auth/login" class="alert-link">Login to your account</a> to write a review.
      </div>
    {% endif %}
  </div>
</div>

<!-- Related Products -->
{% if related_products %}
<hr class="my-5">
<div class="mt-4 animate-fadeInUp">
  <h4 class="fw-bold mb-4 heading-accent"><i class="bi bi-stars me-2"></i>Related Products</h4>
  <div class="row g-4">
    {% for p in related_products %}
    <div class="col-6 col-md-3">
      <div class="card h-100 product-card position-relative shadow-sm hover-lift">
        <div class="product-badges">
          {% if p.old_price and p.price and p.old_price|float > p.price|float %}
            {% set pct = ((1 - (p.price|float / p.old_price|float)) * 100) | round(0, 'floor') %}
            <span class="badge-deal animate-pulse"><i class="bi bi-lightning-fill me-1"></i>-{{ pct|int }}%</span>
          {% endif %}
          {% if p.is_deal %}
            <span class="badge bg-danger text-white position-absolute top-0 start-0 m-2">Deal</span>
          {% endif %}
          {% if p.is_new %}
            <span class="badge bg-success text-white position-absolute top-0 end-0 m-2">New</span>
          {% endif %}
        </div>
        <div class="ratio ratio-4x3 overflow-hidden bg-light">
          <img loading="lazy" class="card-img-top object-fit-cover" src="{{ cl_transform(p.image_url, 600, 450) or 'https://placehold.co/600x400' }}" alt="{{p.name}}">
        </div>
        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-2 text-truncate fw-600" title="{{p.name}}">{{p.name}}</h6>
          <div class="mb-3">
            <span class="text-success fw-bold">Ksh {{p.price}}</span>
            {% if p.old_price %}<small class="text-muted text-decoration-line-through ms-1">{{p.old_price}}</small>{% endif %}
          </div>
          <div class="mt-auto d-flex gap-2 flex-wrap">
            <a class="btn btn-sm btn-outline-success fw-600" href="/product/{{p.slug}}"><i class="bi bi-eye"></i> <span class="d-none d-lg-inline">View</span></a>
            {% if current_user.is_authenticated %}
              <button class="btn btn-sm btn-success btn-add-to-cart btn-async fw-600" data-product-id="{{p.id}}"><i class="bi bi-bag-plus"></i> <span class="d-none d-lg-inline">Add</span></button>
            {% else %}
              <a class="btn btn-sm btn-success fw-600" href="/auth/login"><i class="bi bi-box-arrow-in-right"></i> <span class="d-none d-lg-inline">Login</span></a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% endblock %}
