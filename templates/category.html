{% extends 'base.html' %}
{% block title %}{{ category.name }} • {{ site_name }}{% endblock %}
{% block meta %}
  <meta name="description" content="Shop {{ category.name }} at {{ site_name }}.">
  <meta property="og:title" content="{{ category.name }} — {{ site_name }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ category.name }} — {{ site_name }}">
  <meta name="twitter:description" content="Browse {{ category.name }} at {{ site_name }}.">
  {% set base = url_for('shop.category', slug=category.slug, _external=True) %}
  <link rel="canonical" href="{{ base }}{% if request.args.get('page') %}?page={{ request.args.get('page') }}{% endif %}">
  {% if pagination %}
    {% if pagination.has_prev %}
      <link rel="prev" href="{{ base }}?page={{ pagination.prev_num }}">
    {% endif %}
    {% if pagination.has_next %}
      <link rel="next" href="{{ base }}?page={{ pagination.next_num }}">
    {% endif %}
  {% endif %}
{% endblock %}
{% block content %}
<div class="container-fluid py-5">
  <!-- Category Hero -->
  <div class="row mb-5 animate-fadeInUp">
    <div class="col-12">
      {% set _imgs = hero_images if hero_images is defined and hero_images else (category.hero_images if category.hero_images is defined else []) %}
      {% set _slides = _imgs[:10] if _imgs else [] %}
      {% if _slides %}
      <div id="categoryHeroCarousel" class="carousel slide rounded-3 overflow-hidden shadow-sm position-relative" data-bs-ride="carousel" style="height: 180px;">
        <div class="carousel-inner h-100">
          {% for img in _slides %}
          <div class="carousel-item h-100 {{ 'active' if loop.first }}">
            <img src="{{ img }}" class="d-block w-100 h-100" alt="{{ category.name }} hero {{ loop.index }}" style="object-fit: cover;">
          </div>
          {% endfor %}
        </div>
        {% if _slides|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#categoryHeroCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#categoryHeroCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
        {% endif %}
        <div class="position-absolute top-50 start-50 translate-middle text-center text-white px-3" style="text-shadow: 0 1px 3px rgba(0,0,0,.5);">
          <h1 class="fw-bold mb-1" style="font-size: 1.4rem;">{{ category.name }}</h1>
          <p class="mb-0" style="font-size: .95rem;">Browse our premium selection of fresh {{ category.name | lower }}</p>
        </div>
      </div>
      {% else %}
      <div class="text-center py-3">
        <h1 class="fw-bold mb-2" style="font-size: 1.5rem;">{{ category.name }}</h1>
        <p class="fs-6 mb-0">Browse our premium selection of fresh {{ category.name | lower }}</p>
      </div>
      {% endif %}
    </div>
  </div>
  {% if current_user.is_authenticated and current_user.is_admin %}
  <div class="mb-3 text-end small">
    <a href="/admin/category-heroes" class="text-decoration-none"><i class="bi bi-images me-1"></i>Manage Hero</a>
  </div>
  {% endif %}

  <div class="row">
    <!-- Sidebar: Categories + Filters -->
    <aside class="col-12 col-md-3 mb-4">
      <!-- Category Navigation -->
      <div class="mb-4">
        <div class="d-flex gap-2 flex-column">
          <a class="btn btn-sm btn-outline-emerald rounded-2 text-start" href="/shop">
            <i class="bi bi-grid-3x3 me-1"></i>All Products
          </a>
          {% for parent in categories if not parent.parent_id %}
          {% set is_active_parent = (parent.id == category.id) or (category.parent_id and category.parent_id == parent.id) %}
          <div class="border rounded-2">
            <a class="btn btn-sm w-100 d-flex justify-content-between align-items-center {{ 'btn-emerald' if is_active_parent else 'btn-outline-emerald' }} rounded-2 text-start" href="/category/{{ parent.slug }}" data-bs-toggle="collapse" data-bs-target="#sub-{{ parent.slug }}" aria-expanded="{{ 'true' if is_active_parent else 'false' }}" aria-controls="sub-{{ parent.slug }}">
              <span>{{ parent.name }}</span>
              <i class="bi bi-chevron-down ms-2"></i>
            </a>
            <div id="sub-{{ parent.slug }}" class="collapse {{ 'show' if is_active_parent }}">
              <div class="p-2 d-flex flex-column gap-1">
                {% for child in categories if child.parent_id and (child.parent_id == parent.id) %}
                <a class="btn btn-sm {{ 'btn-emerald' if child.id == category.id else 'btn-outline-emerald' }} rounded-2 text-start" href="/category/{{ child.slug }}">{{ child.name }}</a>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Filters & Sorting -->
      <form class="row g-3 align-items-end animate-fadeInUp" method="get" action="{{ url_for('shop.category', slug=category.slug) }}">
        <div class="col-12">
          <label class="form-label small">Min Price</label>
          <input type="number" step="0.01" class="form-control form-control-sm" name="min" value="{{ request.args.get('min','') }}" placeholder="0">
        </div>
        <div class="col-12">
          <label class="form-label small">Max Price</label>
          <input type="number" step="0.01" class="form-control form-control-sm" name="max" value="{{ request.args.get('max','') }}" placeholder="10000">
        </div>
        {% if subcategories and subcategories|length > 0 %}
        <div class="col-12">
          <label class="form-label small">Subcategory</label>
          {% set sel = selected_sub or request.args.get('sub') %}
          <select name="sub" class="form-select form-select-sm">
            <option value="">All</option>
            {% for sc in subcategories %}
            <option value="{{ sc.slug }}" {{ 'selected' if sel==sc.slug }}>{{ sc.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div class="col-12">
          <label class="form-label small">Rating</label>
          {% set r = request.args.get('rating') %}
          <select name="rating" class="form-select form-select-sm">
            <option value="">Any</option>
            <option value="4" {{ 'selected' if r=='4' }}>4+ stars</option>
            <option value="3" {{ 'selected' if r=='3' }}>3+ stars</option>
            <option value="2" {{ 'selected' if r=='2' }}>2+ stars</option>
            <option value="1" {{ 'selected' if r=='1' }}>1+ stars</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label small">Sort by</label>
          {% set s = request.args.get('sort','newest') %}
          <select name="sort" class="form-select form-select-sm">
            <option value="newest" {{ 'selected' if s=='newest' }}>Newest</option>
            <option value="price_asc" {{ 'selected' if s=='price_asc' }}>Price: Low to High</option>
            <option value="price_desc" {{ 'selected' if s=='price_desc' }}>Price: High to Low</option>
            <option value="rating" {{ 'selected' if s=='rating' }}>Top Rated</option>
          </select>
        </div>
        <div class="col-12">
          {% set stock = request.args.get('in_stock') %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="inStock" name="in_stock" value="1" {{ 'checked' if stock=='1' }}>
            <label class="form-check-label" for="inStock">In stock only</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-emerald btn-sm px-3 w-100"><i class="bi bi-funnel me-1"></i>Apply Filters</button>
          <a class="btn btn-outline-emerald btn-sm w-100" href="{{ url_for('shop.category', slug=category.slug) }}">Reset</a>
        </div>
      </form>
    </aside>

    <!-- Content: Products Grid -->
    <section class="col-12 col-md-9">
      <div class="row g-4 mb-5">
        {% if products %}
          {% for p in products %}
          <div class="col-12 col-sm-6 col-lg-4 col-xl-3 animate-fadeInUp" style="animation-delay: {{ loop.index0 * 0.05 }}s">
            <div class="card border-0 shadow-sm rounded-3 h-100 hover-shadow transition-all overflow-hidden">
              <!-- Image Container -->
              <div class="position-relative overflow-hidden" style="height: 240px;">
                <img loading="lazy" 
                     class="img-fluid w-100 h-100 object-fit-cover" 
                     src="{{ cl_transform(p.image_url, 400, 300) or 'https://placehold.co/400x300' }}" 
                     alt="{{ p.name }}">
                
                <!-- Badges -->
                {% if p.old_price and p.price and p.old_price|float > p.price|float %}
                {% set pct = ((1 - (p.price|float / p.old_price|float)) * 100) | round(0, 'floor') %}
                <div class="position-absolute top-0 start-0 p-2">
                  <span class="badge bg-danger rounded-pill px-3 py-2">
                    <i class="bi bi-lightning-fill me-1"></i>-{{ pct|int }}%
                  </span>
                </div>
                {% endif %}

                {% if p.created_at and (p.created_at.date() >= (datetime.utcnow().date() - timedelta(days=14))) %}
                <div class="position-absolute top-0 end-0 p-2">
                  <span class="badge bg-success rounded-pill px-3 py-2">
                    <i class="bi bi-star-fill me-1"></i>New
                  </span>
                </div>
                {% endif %}

                <!-- Wishlist Button -->
                {% if current_user.is_authenticated %}
                <div class="position-absolute bottom-0 end-0 p-2">
                  <button class="btn btn-sm btn-outline-danger rounded-circle btn-wishlist" 
                          data-product-id="{{ p.id }}"
                          title="Add to wishlist">
                    <i class="bi bi-heart"></i>
                  </button>
                </div>
                {% endif %}
              </div>

              <!-- Product Info -->
              <div class="card-body d-flex flex-column p-4">
                <!-- Name -->
                <a href="/product/{{ p.slug }}" class="text-decoration-none">
                  <h6 class="fw-bold text-slate-800 mb-2 text-truncate-2">{{ p.name }}</h6>
                </a>

                <!-- Rating -->
                <div class="mb-2">
                  <span class="text-warning">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-half"></i>
                  </span>
                  <span class="text-slate-600 text-sm ms-1">(4.5)</span>
                </div>

                <!-- Price -->
                <div class="mb-3">
                  {% if p.old_price and p.old_price|float > p.price|float %}
                  <div class="d-flex gap-2 align-items-center">
                    <span class="h5 fw-bold text-emerald mb-0">Ksh {{ '%.0f'|format(p.price) }}</span>
                    <span class="text-muted text-decoration-line-through small">Ksh {{ '%.0f'|format(p.old_price) }}</span>
                  </div>
                  {% else %}
                  <span class="h5 fw-bold text-emerald mb-0">Ksh {{ '%.0f'|format(p.price) }}</span>
                  {% endif %}
                </div>

                <!-- Stock -->
                {% if p.stock is not none and p.stock|int <= 0 %}
                <div class="mb-3">
                  <span class="badge bg-danger-light text-danger rounded-pill px-3 py-1">
                    <i class="bi bi-x-circle me-1"></i>Out of Stock
                  </span>
                </div>
                {% else %}
                <div class="mb-3">
                  <span class="badge bg-success-light text-success rounded-pill px-3 py-1">
                    <i class="bi bi-check-circle me-1"></i>In Stock
                  </span>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="mt-auto d-flex gap-2">
                  <a class="btn btn-sm btn-outline-emerald rounded-2 flex-grow-1" href="/product/{{ p.slug }}">
                    <i class="bi bi-eye"></i> View
                  </a>
                  {% if current_user.is_authenticated %}
                    {% if p.stock is not none and p.stock|int <= 0 %}
                    <button class="btn btn-sm btn-secondary rounded-2 flex-grow-1" disabled title="Out of stock">
                      <i class="bi bi-bag"></i> Out
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-emerald rounded-2 flex-grow-1 btn-add-to-cart" data-product-id="{{ p.id }}" data-product-slug="{{ p.slug }}">
                      <i class="bi bi-bag-plus"></i> Add
                    </button>
                    <div class="d-flex align-items-center gap-1 flex-grow-1" data-qty-controls data-product-id="{{ p.id }}" data-product-slug="{{ p.slug }}" hidden>
                      <button type="button" class="btn btn-sm btn-outline-secondary cat-qty-dec">-</button>
                      <input type="number" class="form-control form-control-sm text-center cat-qty-input" value="1" min="0" max="99" style="width:56px;" />
                      <button type="button" class="btn btn-sm btn-outline-secondary cat-qty-inc">+</button>
                    </div>
                    {% endif %}
                  {% else %}
                  
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
        <!-- Empty State -->
        <div class="col-12 text-center py-5">
          <div style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;">
            <i class="bi bi-inbox"></i>
          </div>
          <h4 class="fw-bold mb-2">No products in this category</h4>
          <p class="text-slate-600 mb-4">Check back soon or browse other categories</p>
          <a href="/shop" class="btn btn-emerald rounded-2 px-5 py-2">
            <i class="bi bi-arrow-left"></i> Back to Shop
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Live Reviews -->
      <div class="row mb-5" data-reviews data-max="10" id="liveReviews">
        <div class="col-12">
          <h5 class="fw-bold mb-3">Recent Reviews</h5>
          <div class="card border-0 shadow-sm rounded-3">
            <div class="card-body" data-reviews-items>
              <div class="text-muted small">Reviews will appear here in real-time.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      {% if pagination and pagination.pages > 1 %}
      <nav aria-label="Page navigation" class="d-flex justify-content-center mb-5 animate-fadeInUp">
        <ul class="pagination rounded-3 overflow-hidden border border-slate-200">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ pagination.prev_num if pagination.has_prev else 1 }}">
              <i class="bi bi-chevron-left"></i> Previous
            </a>
          </li>
          
          {% for p in range(1, pagination.pages + 1) %}
            {% if p == pagination.page %}
            <li class="page-item active">
              <span class="page-link bg-emerald border-emerald">{{ p }}</span>
            </li>
            {% elif p == 1 or p == pagination.pages or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
            <li class="page-item">
              <a class="page-link" href="?page={{ p }}">{{ p }}</a>
            </li>
            {% elif p == pagination.page - 2 or p == pagination.page + 2 %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% endif %}
          {% endfor %}
          
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ pagination.next_num if pagination.has_next else pagination.pages }}">
              Next <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </section>
  </div>
</div>
<style>
.text-truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.bg-success-light { background-color: rgba(34, 197, 94, 0.1); }
.bg-danger-light { background-color: rgba(239, 68, 68, 0.1); }
.object-fit-cover {
  object-fit: cover;
}
</style>
<div id="catProceedBar" class="position-fixed bottom-0 start-0 end-0 d-none" style="z-index:1039;">
  <div class="container">
    <div class="bg-success text-white rounded-top d-flex justify-content-between align-items-center p-2 shadow">
      <span class="fw-600"><i class="bi bi-bag-check me-2"></i><span id="catProceedCount">0</span> item(s) in cart</span>
      <div class="d-flex gap-2">
        <a href="/cart/" class="btn btn-outline-light btn-sm">View Cart</a>
        <a href="/orders/checkout" class="btn btn-light btn-sm">Proceed</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
